#!/usr/bin/env Rscript
#' Build the environment for LinkOrgs machine learning models. Builds a conda environment in which jax, optax, equinox, and jmp are installed.
#'
#' @param conda_env (default = `"LinkOrgsEnv"`) Name of the conda environment in which to place the backends.
#' @param conda (default = `auto`) The path to a conda executable. Using `"auto"` allows reticulate to attempt to automatically find an appropriate conda binary.

#' @return Builds the computational environment for `LinkOrgs`. This function requires an Internet connection.
#' You may find out a list of conda Python paths via: `system("which python")`
#'
#' @examples
#' # For a tutorial, see
#' # github.com/cjerzak/linkorgs-software/
#'
#' @export
#' @md

BuildBackend <- function(conda_env = "LinkOrgsEnv", conda = "auto"){
  # Create a new conda environment
  reticulate::conda_create(envname = conda_env,
                           conda = conda, python_version = "3.11")

  # Install Python packages within the environment
  reticulate::py_install(c("optax", "equinox", "jmp"),
                           conda = conda, pip = TRUE,
                           envname = conda_env)
  if(Sys.info()["sysname"] == "Darwin"){
    try_ <- try(reticulate::py_install("jax-metal", conda = conda, pip = TRUE,
                                       envname = conda_env), T)
    if("try-error" %in% class(try_)){
      print("Failed to establish connection with jax-metal, falling back to jax...")
      try_ <- try(reticulate::py_install("jax", conda = conda, pip = TRUE,
                                         envname = conda_env), T)
    }
  }
  if(Sys.info()["sysname"] == "Windows"){
    reticulate::py_install("jax", conda = conda, pip = TRUE,
                           envname = conda_env)
  }
  if(Sys.info()["sysname"] == "Linux"){
    # pip install --upgrade jax jaxlib==0.1.69+cuda111 -f https://storage.googleapis.com/jax-releases/jax_releases.html
    try_ <- try(system(sprintf("'%s' -m pip install --upgrade --no-user %s",
           gsub(conda, pattern = "bin/python", replacement = sprintf("envs/%s/bin/python",conda_env)),
           "'jax[cuda12_pip]' -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html" )), T)
    if("try-error" %in% class(try_)){
      print("Failed to establish connection with jax[cuda12_pip], falling back to jax...")
      try_ <- try(reticulate::py_install("jax", conda = conda, pip = TRUE,
                                         envname = conda_env), T)
    }
  }
  print("Done building LinkOrgs backend!")
}

